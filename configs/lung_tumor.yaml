# Lung Tumor Segmentation Configuration
# ======================================

# Model Configuration
model:
  type: attention_unet   # Options: unet, attention_unet
  n_channels: 1          # Grayscale CT images
  n_classes: 2           # Background + Tumor
  bilinear: true         # Use bilinear upsampling (vs transposed conv)
  base_features: 64      # Base number of features
  deep_supervision: false # Stage 3: disabled to remove conflicting gradients

# Data Configuration
data:
  root: ./dataset
  img_size: 512          # Higher resolution for small tumor detection (was 256)
  val_ratio: 0.2         # 20% for validation
  batch_size: 4          # Reduced for 512 input (was 8)
  num_workers: 4

# Training Configuration
train:
  epochs: 150            # Stage 4: same budget
  lr: 0.00005            # Stage 4: target lr after warmup
  weight_decay: 0.0001   # Stage 1: lowered from 1e-3 to 1e-4
  grad_clip: 1.0         # Gradient clipping (0 to disable)
  accumulation_steps: 8  # Gradient accumulation (effective batch = 4 x 8 = 32)

# Learning Rate Scheduler
scheduler:
  type: warmup_cosine      # Stage 4: linear warmup then cosine decay
  warmup_epochs: 10        # First 10 epochs: lr ramps 0 â†’ 5e-5 (avoid early oscillation)
  min_lr: 0.000001

# EMA (Exponential Moving Average)
ema:
  enabled: true            # Stage 4: re-enabled (training is now stable with DiceBCE)
  decay: 0.999             # High decay for smooth averaging
  warmup_epochs: 10        # First 10 epochs: validate with training model (align with LR warmup)

# Early Stopping
early_stopping:
  enabled: true
  patience: 30             # Stage 4: 30 epochs (was 50)
  monitor: class_dice.tumor
  mode: max

# Loss Function
loss:
  type: dice_bce              # Stage 3: BalancedCE + Dice (stable, smooth gradients)
  balanced_class_weight: 0.5  # Weight for tumor class (0.5 = equal attention)
  ce_weight: 1.0              # Weight for balanced CE component
  dice_weight: 1.0            # Weight for Dice component

# Data Augmentation
augmentation:
  enabled: true
  horizontal_flip: 0.5   # Probability
  rotation_limit: 15     # Max rotation angle
  elastic: 0.3           # Elastic deformation probability
  brightness_contrast: 0.3

# Output Configuration
output:
  save_dir: ./runs
  experiment_name: lung_tumor_ds512
  save_last: true        # Save last checkpoint
  save_best: true        # Save best checkpoint

# Reproducibility
seed: 42

# Device
device: ""               # Empty for auto-detect (cuda > mps > cpu)
